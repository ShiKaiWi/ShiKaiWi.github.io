<!DOCTYPE html>
<html lang="">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="description" content="React-源码阅读[2]"/>




  <meta name="keywords" content="react," />




  <link rel="alternate" href="/atom.xml" title="ShiKaiWi's Homepage">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.2.x" />



<link rel="canonical" href="https://ShiKaiWi.github.io/2017/07/01/React-源码阅读-Component-Mount/"/>


<meta name="description" content="Mount 一个 ComponentcallstackReactDomStackEntry =&amp;gt; ReactMount =&amp;gt; InstantiateReactComponent =&amp;gt; CompositeComponent
ReactMountInterfaces:

scrollMonitor
renderSubtreeIntoContainer
render
unmountCo">
<meta property="og:type" content="article">
<meta property="og:title" content="React-源码阅读[2]">
<meta property="og:url" content="https://ShiKaiWi.github.io/2017/07/01/React-源码阅读-Component-Mount/index.html">
<meta property="og:site_name" content="ShiKaiWi's Homepage">
<meta property="og:description" content="Mount 一个 ComponentcallstackReactDomStackEntry =&amp;gt; ReactMount =&amp;gt; InstantiateReactComponent =&amp;gt; CompositeComponent
ReactMountInterfaces:

scrollMonitor
renderSubtreeIntoContainer
render
unmountCo">
<meta property="og:updated_time" content="2017-07-16T01:46:02.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="React-源码阅读[2]">
<meta name="twitter:description" content="Mount 一个 ComponentcallstackReactDomStackEntry =&amp;gt; ReactMount =&amp;gt; InstantiateReactComponent =&amp;gt; CompositeComponent
ReactMountInterfaces:

scrollMonitor
renderSubtreeIntoContainer
render
unmountCo">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.2.x" />



  <link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css" />





<script type="text/javascript">
  var themeConfig = {
    search: {
      enable: true,
      path: "/search.xml",
    },
    navbar: {
      enable: true
    },
    fancybox: {
      enable: true
    },
    toc: {
      enable: true
    },
  };
</script>



  



    <title> React-源码阅读[2] · ShiKaiWi's Homepage </title>
  </head>

  <body>
    <div class="container">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">ShiKaiWi's Homepage</a>
</div>

<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              Home
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              Archives
            
          </a>
        </li>
      
      
        <li class="menu-search">
          <form>
            <i class="iconfont icon-search" id="open-search"></i>
            <input type="text" class="search-input" id="search-input" />
            <i class="iconfont icon-close" id="close-search"></i>
          </form>
        </li>
      
    </ul>
  
</nav>

<div class="mobile-navbar">
  <div class="mobile-header">
    <div class="mobile-header-logo">
      <a href="/." class="logo">ShiKaiWi's Homepage</a>
    </div>

    <div class="mobile-header-icon">
      <span></span>
      <span></span>
      <span></span>
    </div>
  </div>
  <nav class="mobile-menu">
    
      <a class="mobile-menu-item" href="/">
        
        
          Home
        
      </a>
    
      <a class="mobile-menu-item" href="/archives/">
        
        
          Archives
        
      </a>
    
  </nav>
</div>
      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          React-源码阅读[2]
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          Jul 1, 2017
        </span>
      </div>
    </header>

    
    
  <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">Contents</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Mount-一个-Component"><span class="toc-text">Mount 一个 Component</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#callstack"><span class="toc-text">callstack</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ReactMount"><span class="toc-text">ReactMount</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#renderNewRootComponent"><span class="toc-text">_renderNewRootComponent</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#batchedMountComponentIntoNode"><span class="toc-text">batchedMountComponentIntoNode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mountComponentIntoNode"><span class="toc-text">mountComponentIntoNode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mountImageIntoNode"><span class="toc-text">_mountImageIntoNode</span></a></li></ol></li></ol>
    </div>
  </div>


    <div class="post-content">
      
        <h2 id="Mount-一个-Component"><a href="#Mount-一个-Component" class="headerlink" title="Mount 一个 Component"></a>Mount 一个 Component</h2><h3 id="callstack"><a href="#callstack" class="headerlink" title="callstack"></a>callstack</h3><p>ReactDomStackEntry =&gt; ReactMount =&gt; InstantiateReactComponent =&gt; CompositeComponent</p>
<h3 id="ReactMount"><a href="#ReactMount" class="headerlink" title="ReactMount"></a>ReactMount</h3><p>Interfaces:</p>
<ol>
<li>scrollMonitor</li>
<li>renderSubtreeIntoContainer</li>
<li>render</li>
<li>unmountComponentAtNode</li>
</ol>
<h3 id="renderNewRootComponent"><a href="#renderNewRootComponent" class="headerlink" title="_renderNewRootComponent"></a>_renderNewRootComponent</h3><ol>
<li>检查</li>
<li>call instantiateReactComponent 得到 componentInstance</li>
<li>call ReactUpdates.batchedUpdates</li>
</ol>
<p>然后 ReactUpdates.batchedUpdates 会 call batchingStrategy.batchedUpdates，而这个实际上是在 call 一个在 ReactUpdates.injection 中注入 batchingStrategy，而实际上注入的是 ReactDefaultBatchingStragety，里面实际就是一个 transaction，并且除了一些特殊的初始化工作，就是调用了传给 ReactUpdates.bacthedUpdates 的 callback<br>而这个 callback 是：batchedMountComponentIntoNode</p>
<h3 id="batchedMountComponentIntoNode"><a href="#batchedMountComponentIntoNode" class="headerlink" title="batchedMountComponentIntoNode"></a>batchedMountComponentIntoNode</h3><ol>
<li>实例化一个 ReactUpdates.ReactReconcileTransaction</li>
<li>然后 perform mountComponentIntoNode, 会传入 transcaction 和 instance</li>
</ol>
<p>这里需要了解一下 ReactUpdates.ReactReconcileTransaction, 这个变量和 ReactUpdates.batchUpdates 一样都是动态注入（其实我不明白为什么要这样做），默认的注入是在 ReactDomStackInjection 里面做的，里面做了大量的 transaction 必要的注入，此外还使用 pooledClass wrappert 一下来提升性能。</p>
<p>和 batchingStrategy 一样，主要其实还是调用 callback。</p>
<p>不过这个 transaction 的调用是这样的：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">transaction.perform(</div><div class="line">    mountComponentIntoNode,</div><div class="line">    <span class="literal">null</span>,</div><div class="line">    componentInstance,</div><div class="line">    container,</div><div class="line">    transaction,</div><div class="line">    shouldReuseMarkup,</div><div class="line">    context,</div><div class="line">  );</div></pre></td></tr></table></figure>
<p>也就是说把自己作为参数传给了 mountComponentIntoNode</p>
<h3 id="mountComponentIntoNode"><a href="#mountComponentIntoNode" class="headerlink" title="mountComponentIntoNode"></a>mountComponentIntoNode</h3><ol>
<li>call ReactReconciler.mountComponent 产生 markup</li>
<li>设置 <code>wrapperInstance._renderedComponent._topLevelWrapper = wrapperInstance</code></li>
<li>call _mountImageIntoNode 传入产生的 markup</li>
</ol>
<p>这里需要知道 ReactReconciler.mountComponent 是做什么的。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">mountComponent: <span class="function"><span class="keyword">function</span>(<span class="params"></span></span></div><div class="line">    internalInstance,</div><div class="line">    transaction,</div><div class="line">    hostParent,</div><div class="line">    hostContainerInfo,</div><div class="line">    context,</div><div class="line">    parentDebugID, <span class="regexp">//</span> <span class="number">0</span> in production and for roots</div><div class="line">  ) &#123;</div><div class="line">    <span class="keyword">if</span> (__DEV__) &#123;</div><div class="line">      <span class="keyword">if</span> (internalInstance._debugID !== <span class="number">0</span>) &#123;</div><div class="line">        ReactInstrumentation.debugTool.onBeforeMountComponent(</div><div class="line">          internalInstance._debugID,</div><div class="line">          internalInstance._currentElement,</div><div class="line">          parentDebugID,</div><div class="line">        );</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">var</span> markup = internalInstance.mountComponent(</div><div class="line">      transaction,</div><div class="line">      hostParent,</div><div class="line">      hostContainerInfo,</div><div class="line">      context,</div><div class="line">      parentDebugID,</div><div class="line">    );</div><div class="line">    <span class="keyword">if</span> (</div><div class="line">      internalInstance._currentElement &amp;&amp;</div><div class="line">      internalInstance._currentElement.ref != <span class="literal">null</span></div><div class="line">    ) &#123;</div><div class="line">      transaction.getReactMountReady().enqueue(attachRefs, internalInstance);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (__DEV__) &#123;</div><div class="line">      <span class="keyword">if</span> (internalInstance._debugID !== <span class="number">0</span>) &#123;</div><div class="line">        ReactInstrumentation.debugTool.onMountComponent(</div><div class="line">          internalInstance._debugID,</div><div class="line">        );</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> markup;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>这里可以看到是把 mount 的工作 delegate 给了 internalInstance.mountComponent, 所以我们还得去看 ReactComponent.mountCompoent 方法, 然而 react 内部其实没有 ReactComponent 这个类，看着它的 type 定义发现 ReactBaseClasses 是 React.Component, 但是又发现这个类，并没有什么 mountCompnent 定义，并且很多函数的定义都是 dummy 的（这里有点不明白），于是我想这应该是一个基类定义吧，然后我又找到了 ReactDOMComponent，这个似乎才是真正会使用到的 ReactComponent。</p>
<p>在 mountComponent 中做了很多具体的工作，总结来说就是产生具体的 html element:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (!tagContent &amp;&amp; omittedCloseTags[<span class="keyword">this</span>._tag]) &#123;</div><div class="line">        mountImage = tagOpen + <span class="string">'/&gt;'</span>;</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        mountImage = tagOpen + <span class="string">'&gt;'</span> + tagContent + <span class="string">'&lt;/'</span> + type + <span class="string">'&gt;'</span>;</div><div class="line">      &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>值得一提的是，这个 mountImage 的含义是 html 内容的意思，并且还是 string 类型的，然后:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">   * Generates root tag markup then recurses. This method has side effects and</div><div class="line">   * is not idempotent.</div><div class="line">   *</div><div class="line">   * @internal</div><div class="line">   * @param &#123;ReactReconcileTransaction|ReactServerRenderingTransaction&#125; transaction</div><div class="line">   * @param &#123;?ReactDOMComponent&#125; the parent component instance</div><div class="line">   * @param &#123;?object&#125; info about the host container</div><div class="line">   * @param &#123;object&#125; context</div><div class="line">   * @return &#123;string&#125; The computed markup.</div><div class="line">   */</div><div class="line">  mountComponent: <span class="function"><span class="keyword">function</span>(<span class="params"></span></span></div><div class="line">    transaction,</div><div class="line">    hostParent,</div><div class="line">    hostContainerInfo,</div><div class="line">    context,</div><div class="line">  ) &#123;</div><div class="line">      <span class="comment">//...</span></div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>注释里面表明 markup 也是类似的含义。</p>
<h3 id="mountImageIntoNode"><a href="#mountImageIntoNode" class="headerlink" title="_mountImageIntoNode"></a>_mountImageIntoNode</h3><p>会根据 shouldReuseMarkup，<br><strong>true</strong>：<br>获取 rootElement，call ReactMarkupChecksum 传入 markup， rootElement，如果返回 true，意味着可以使用 <code>ReactDOMComponentTree.precacheNode(instance, rootElement)</code> 来做到快速 mount，然后直接返回，所用的工作就算完成了。</p>
<p>这里需要知道 React.MarkupChecksum.canReuseMarkup 的实现：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">   * @param &#123;string&#125; markup to use</div><div class="line">   * @param &#123;DOMElement&#125; element root React element</div><div class="line">   * @returns &#123;boolean&#125; whether or not the markup is the same</div><div class="line">   */</div><div class="line">  canReuseMarkup: <span class="function"><span class="keyword">function</span>(<span class="params">markup, element</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> existingChecksum = element.getAttribute(</div><div class="line">      ReactMarkupChecksum.CHECKSUM_ATTR_NAME,</div><div class="line">    );</div><div class="line">    existingChecksum = existingChecksum &amp;&amp; <span class="built_in">parseInt</span>(existingChecksum, <span class="number">10</span>);</div><div class="line">    <span class="keyword">var</span> markupChecksum = adler32(markup);</div><div class="line">    <span class="keyword">return</span> markupChecksum === existingChecksum;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>这里一目了然，对于react render 出来的 element 肯定会把一个 checksum 存到  ReactMarkupChecksum.CHECKSUM_ATTR_NAME 中去。</p>
<p>这里还需要知道 ReactDOMComponentTree.precachedNode 的具体实现：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Drill down (through composites and empty components) until we get a host or</div><div class="line"> * host text component.</div><div class="line"> *</div><div class="line"> * This is pretty polymorphic but unavoidable with the current structure we have</div><div class="line"> * for `_renderedChildren`.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRenderedHostOrTextFromComponent</span>(<span class="params">component</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> rendered;</div><div class="line">  <span class="keyword">while</span> ((rendered = component._renderedComponent)) &#123;</div><div class="line">    component = rendered;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> component;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//...</span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Populate `_hostNode` on the rendered host/text component with the given</div><div class="line"> * DOM node. The passed `inst` can be a composite.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">precacheNode</span>(<span class="params">inst, node</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> hostInst = getRenderedHostOrTextFromComponent(inst);</div><div class="line">  hostInst._hostNode = node;</div><div class="line">  node[internalInstanceKey] = hostInst;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里非常需要知道 inst._renderedComponent 是什么。<br>我找来找去发现，一个 instance 的 _renderedComponent 是在 ReactCompositeComponent 中赋值的：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">performInitialMount: <span class="function"><span class="keyword">function</span>(<span class="params"></span></span></div><div class="line">    renderedElement,</div><div class="line">    hostParent,</div><div class="line">    hostContainerInfo,</div><div class="line">    transaction,</div><div class="line">    context,</div><div class="line">  ) &#123;</div><div class="line">    <span class="comment">// If not a stateless component, we now render</span></div><div class="line">    <span class="keyword">if</span> (renderedElement === <span class="literal">undefined</span>) &#123;</div><div class="line">      renderedElement = <span class="keyword">this</span>._renderValidatedComponent();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> nodeType = ReactNodeTypes.getType(renderedElement);</div><div class="line">    <span class="keyword">this</span>._renderedNodeType = nodeType;</div><div class="line">    <span class="keyword">var</span> child = <span class="keyword">this</span>._instantiateReactComponent(</div><div class="line">      renderedElement,</div><div class="line">      nodeType !== ReactNodeTypes.EMPTY <span class="comment">/* shouldHaveDebugID */</span>,</div><div class="line">    );</div><div class="line">    <span class="keyword">this</span>._renderedComponent = child;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> debugID = <span class="number">0</span>;</div><div class="line">    <span class="keyword">if</span> (__DEV__) &#123;</div><div class="line">      debugID = <span class="keyword">this</span>._debugID;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> markup = ReactReconciler.mountComponent(</div><div class="line">      child,</div><div class="line">      transaction,</div><div class="line">      hostParent,</div><div class="line">      hostContainerInfo,</div><div class="line">      <span class="keyword">this</span>._processChildContext(context),</div><div class="line">      debugID,</div><div class="line">    );</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (__DEV__) &#123;</div><div class="line">      <span class="keyword">if</span> (debugID !== <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">var</span> childDebugIDs = child._debugID !== <span class="number">0</span> ? [child._debugID] : [];</div><div class="line">        ReactInstrumentation.debugTool.onSetChildren(debugID, childDebugIDs);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> markup;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>这段代码可以说是相当顶层的调用，所以不用太深入去看（因为我们正在一个 call stack 的追踪当中），记住我们的目的是要找到 _renderedComponent 的赋值语句，发现是：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (renderedElement === <span class="literal">undefined</span>) &#123;</div><div class="line">      renderedElement = <span class="keyword">this</span>._renderValidatedComponent();</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="keyword">var</span> nodeType = ReactNodeTypes.getType(renderedElement);</div><div class="line"><span class="keyword">this</span>._renderedNodeType = nodeType;</div><div class="line"><span class="keyword">var</span> child = <span class="keyword">this</span>._instantiateReactComponent(</div><div class="line">    renderedElement,</div><div class="line">    nodeType !== ReactNodeTypes.EMPTY <span class="comment">/* shouldHaveDebugID */</span>,</div><div class="line">);</div><div class="line"><span class="keyword">this</span>._renderedComponent = child;</div></pre></td></tr></table></figure>
<p>（其实 renderedElement 是由 this 的 _constructComponent 函数生成的一个 ReactComponent Instance，所以之后用 this._instantiateReactComponent 生成出来的是 child，这个下面会仔细提到）<br>它存储了一个 ReactComponent 的 instance，但是我们要知道，先前的代码是存在一个<strong>链表</strong>结构的，所以要注意之后 child 还被执行了什么操作————还被使用 ReactReconciler.mountComponent 执行了一遍，而这个 method 是被分析过的，并且它是通过调用 ReactComponent 的 Instance 的 mountComponent 的方法来进行真正的 mount 工作。</p>
<p>循环调用：<br>performInitialMount =&gt; ReactReconciler.mountComponent =&gt; Component.mountComponent<br>       ||                                                         ||<br>        \======================================================== /</p>
<p>为了搞清楚这块调用逻辑，我试图追踪 this._renderedComponent 的改动轨迹：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 在 ReactCompositeComponent 中</span></div><div class="line">performInitialMount: <span class="function"><span class="keyword">function</span>(<span class="params"></span></span></div><div class="line">    renderedElement,</div><div class="line">    hostParent,</div><div class="line">    hostContainerInfo,</div><div class="line">    transaction,</div><div class="line">    context,</div><div class="line">  ) &#123;</div><div class="line">    <span class="comment">// If not a stateless component, we now render</span></div><div class="line">    <span class="keyword">if</span> (renderedElement === <span class="literal">undefined</span>) &#123;</div><div class="line">      renderedElement = <span class="keyword">this</span>._renderValidatedComponent();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> nodeType = ReactNodeTypes.getType(renderedElement);</div><div class="line">    <span class="keyword">this</span>._renderedNodeType = nodeType;</div><div class="line">    <span class="keyword">var</span> child = <span class="keyword">this</span>._instantiateReactComponent(</div><div class="line">      renderedElement,</div><div class="line">      nodeType !== ReactNodeTypes.EMPTY <span class="comment">/* shouldHaveDebugID */</span>,</div><div class="line">    );</div><div class="line">    <span class="keyword">this</span>._renderedComponent = child;</div><div class="line">    <span class="comment">//...</span></div><div class="line">    <span class="keyword">var</span> markup = ReactReconciler.mountComponent(</div><div class="line">      child, <span class="comment">// 这里被调用了</span></div><div class="line">      transaction,</div><div class="line">      hostParent,</div><div class="line">      hostContainerInfo,</div><div class="line">      <span class="keyword">this</span>._processChildContext(context),</div><div class="line">      debugID,</div><div class="line">    );</div></pre></td></tr></table></figure></p>
<p>这段代码中的 child 生成也是需要注意的，也就是说 this._instantiateReactComponent 这个 function 做的是什么事情呢？<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Given a ReactNode, create an instance that will actually be mounted.</div><div class="line"> *</div><div class="line"> * @param &#123;ReactNode&#125; node</div><div class="line"> * @param &#123;boolean&#125; shouldHaveDebugID</div><div class="line"> * @return &#123;object&#125; A new instance of the element's constructor.</div><div class="line"> * @protected</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">instantiateReactComponent</span>(<span class="params">node, shouldHaveDebugID</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> instance;</div><div class="line">  <span class="comment">//...</span></div></pre></td></tr></table></figure></p>
<p>不深入这段代码可以发现这是一段根据 ReactNode（关于 ReactNode 的定义需要仔细研究）来 instance 一个 ReactComponent 的 instance 的方法。</p>
<p>那么我们在深入到 ReactReconciler 的代码中看一下这个 child（ReactComponent 的 instance）究竟被用来做什么了。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">   * Initializes the component, renders markup, and registers event listeners.</div><div class="line">   *</div><div class="line">   * @param &#123;ReactComponent&#125; internalInstance</div><div class="line">   * @param &#123;ReactReconcileTransaction|ReactServerRenderingTransaction&#125; transaction</div><div class="line">   * @param &#123;?object&#125; the containing host component instance</div><div class="line">   * @param &#123;?object&#125; info about the host container</div><div class="line">   * @return &#123;?string&#125; Rendered markup to be inserted into the DOM.</div><div class="line">   * @final</div><div class="line">   * @internal</div><div class="line">   */</div><div class="line">  mountComponent: <span class="function"><span class="keyword">function</span>(<span class="params"></span></span></div><div class="line">    internalInstance,</div><div class="line">    transaction,</div><div class="line">    hostParent,</div><div class="line">    hostContainerInfo,</div><div class="line">    context,</div><div class="line">    parentDebugID, <span class="regexp">//</span> <span class="number">0</span> in production and for roots</div><div class="line">  ) &#123;</div><div class="line">    <span class="keyword">if</span> (__DEV__) &#123;</div><div class="line">      <span class="keyword">if</span> (internalInstance._debugID !== <span class="number">0</span>) &#123;</div><div class="line">        ReactInstrumentation.debugTool.onBeforeMountComponent(</div><div class="line">          internalInstance._debugID,</div><div class="line">          internalInstance._currentElement,</div><div class="line">          parentDebugID,</div><div class="line">        );</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">var</span> markup = internalInstance.mountComponent(<span class="comment">// 直接又调用了 ReactComponent 的mountComponent 的方法</span></div><div class="line">      transaction,</div><div class="line">      hostParent,</div><div class="line">      hostContainerInfo,</div><div class="line">      context,</div><div class="line">      parentDebugID,</div><div class="line">    );</div><div class="line"><span class="comment">//...</span></div></pre></td></tr></table></figure></p>
<p>这里需要注意的是， 这个 internalInstance 是之前的 child，但是这个 child 不一定是 ReactCompositeComponent 类型的 Instance，也有可能是其他类型的 Component 的 Instance，不过我们可以先看，如果是 ReactCompositeComponent 类型的 Instance 的话，怎么处理？<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ReactCompositeComponent.js</span></div><div class="line"><span class="comment">/**</span></div><div class="line">   * Initializes the component, renders markup, and registers event listeners.</div><div class="line">   *</div><div class="line">   * @param &#123;ReactReconcileTransaction|ReactServerRenderingTransaction&#125; transaction</div><div class="line">   * @param &#123;?object&#125; hostParent</div><div class="line">   * @param &#123;?object&#125; hostContainerInfo</div><div class="line">   * @param &#123;?object&#125; context</div><div class="line">   * @return &#123;?string&#125; Rendered markup to be inserted into the DOM.</div><div class="line">   * @final</div><div class="line">   * @internal</div><div class="line">   */</div><div class="line">  mountComponent: <span class="function"><span class="keyword">function</span>(<span class="params"></span></span></div><div class="line">    transaction,</div><div class="line">    hostParent,</div><div class="line">    hostContainerInfo,</div><div class="line">    context,</div><div class="line">  ) &#123;</div><div class="line">    <span class="keyword">this</span>._context = context;</div><div class="line">    <span class="keyword">this</span>._mountOrder = nextMountID++;</div><div class="line">    <span class="keyword">this</span>._hostParent = hostParent;</div><div class="line">    <span class="keyword">this</span>._hostContainerInfo = hostContainerInfo;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> publicProps = <span class="keyword">this</span>._currentElement.props;</div><div class="line">    <span class="keyword">var</span> publicContext = <span class="keyword">this</span>._processContext(context);</div><div class="line"></div><div class="line">    <span class="keyword">var</span> Component = <span class="keyword">this</span>._currentElement.type;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> updateQueue = transaction.getUpdateQueue();</div><div class="line"></div><div class="line">    <span class="comment">// Initialize the public class</span></div><div class="line">    <span class="keyword">var</span> doConstruct = shouldConstruct(Component);</div><div class="line">    <span class="keyword">var</span> inst = <span class="keyword">this</span>._constructComponent(</div><div class="line">      doConstruct,</div><div class="line">      publicProps,</div><div class="line">      publicContext,</div><div class="line">      updateQueue,</div><div class="line">    );</div><div class="line">    <span class="keyword">var</span> renderedElement; <span class="comment">// 注意这个 renderedElement</span></div><div class="line"></div><div class="line">    <span class="comment">// Support functional components</span></div><div class="line">    <span class="keyword">if</span> (!doConstruct &amp;&amp; (inst == <span class="literal">null</span> || inst.render == <span class="literal">null</span>)) &#123;</div><div class="line">      renderedElement = inst; <span class="comment">// 同时当 doConstruct 和 inst 为空的时候，持有一份 inst，应该其实就是空</span></div><div class="line">      <span class="keyword">if</span> (__DEV__) &#123;</div><div class="line">        warning(</div><div class="line">          !Component.childContextTypes,</div><div class="line">          <span class="string">'%s(...): childContextTypes cannot be defined on a functional component.'</span>,</div><div class="line">          Component.displayName || Component.name || <span class="string">'Component'</span>,</div><div class="line">        );</div><div class="line">      &#125;</div><div class="line"><span class="comment">//...</span></div><div class="line">    <span class="keyword">var</span> markup;</div><div class="line">    <span class="keyword">if</span> (inst.unstable_handleError) &#123;</div><div class="line">      markup = <span class="keyword">this</span>.performInitialMountWithErrorHandling(</div><div class="line">        renderedElement,  </div><div class="line">        hostParent,</div><div class="line">        hostContainerInfo,</div><div class="line">        transaction,</div><div class="line">        context,</div><div class="line">      );</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      markup = <span class="keyword">this</span>.performInitialMount(</div><div class="line">        renderedElement,</div><div class="line">        hostParent,</div><div class="line">        hostContainerInfo,</div><div class="line">        transaction,</div><div class="line">        context,</div><div class="line">      );</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>需要注意的是，这里的 this 其实就是之前的 child，所以这里会很奇怪，取了 child 的属性，然后又调用 _constructrComponent 方法来进行:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line">_constructComponent: <span class="function"><span class="keyword">function</span>(<span class="params"></span></span></div><div class="line">    doConstruct,</div><div class="line">    publicProps,</div><div class="line">    publicContext,</div><div class="line">    updateQueue,</div><div class="line">  ) &#123;</div><div class="line">    <span class="keyword">if</span> (__DEV__) &#123;</div><div class="line">      ReactCurrentOwner.current = <span class="keyword">this</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>._constructComponentWithoutOwner(</div><div class="line">          doConstruct,</div><div class="line">          publicProps,</div><div class="line">          publicContext,</div><div class="line">          updateQueue,</div><div class="line">        );</div><div class="line">      &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        ReactCurrentOwner.current = <span class="literal">null</span>;</div><div class="line">      &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">this</span>._constructComponentWithoutOwner(</div><div class="line">        doConstruct,</div><div class="line">        publicProps,</div><div class="line">        publicContext,</div><div class="line">        updateQueue,</div><div class="line">      );</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line"></div><div class="line"><span class="attr">_constructComponentWithoutOwner</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span></span></div><div class="line">    doConstruct,</div><div class="line">    publicProps,</div><div class="line">    publicContext,</div><div class="line">    updateQueue,</div><div class="line">  ) &#123;</div><div class="line">    <span class="keyword">var</span> Component = <span class="keyword">this</span>._currentElement.type; <span class="comment">// 注意这里</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> (doConstruct) &#123;</div><div class="line">      <span class="keyword">if</span> (__DEV__) &#123;</div><div class="line">        <span class="keyword">return</span> measureLifeCyclePerf(</div><div class="line">          <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">new</span> Component(publicProps, publicContext, updateQueue),</div><div class="line">          <span class="keyword">this</span>._debugID,</div><div class="line">          <span class="string">'ctor'</span>,</div><div class="line">        );</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Component(publicProps, publicContext, updateQueue);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"><span class="comment">//...</span></div></pre></td></tr></table></figure></p>
<p>最终 又新建了一个 Component 的 instance，我们来从一开始追溯到这里，看看 <code>var Component = this._currentElement.type</code> 这句里面的 Component 究竟和 child 是什么关系:<br><code>var Component = child._currentElement.type;</code> （因为这里的 this 就是 child）<br>所以这里返回的又是和 child 本身类型相同的 Instance（也许这里类型不一致），非常古怪。</p>
<p>然后在回到之前的代码，我们发现，performInitialMount method 又被调用了，并且传入 this 就是 child 和 renderedElement 就是 null 或者是上面提到的用 child 的 _currentElement.type 构造出来的 Instance。</p>
<p>这个时候，我们发现原来：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">performInitialMount: <span class="function"><span class="keyword">function</span>(<span class="params"></span></span></div><div class="line">    renderedElement,</div><div class="line">    hostParent,</div><div class="line">    hostContainerInfo,</div><div class="line">    transaction,</div><div class="line">    context,</div><div class="line">  ) &#123;</div><div class="line">    <span class="comment">// If not a stateless component, we now render</span></div><div class="line">    <span class="keyword">if</span> (renderedElement === <span class="literal">undefined</span>) &#123;</div><div class="line">      renderedElement = <span class="keyword">this</span>._renderValidatedComponent();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">var</span> nodeType = ReactNodeTypes.getType(renderedElement);</div><div class="line">    <span class="keyword">this</span>._renderedNodeType = nodeType;</div><div class="line">    <span class="keyword">var</span> child = <span class="keyword">this</span>._instantiateReactComponent(</div><div class="line">      renderedElement,</div><div class="line">      nodeType !== ReactNodeTypes.EMPTY <span class="comment">/* shouldHaveDebugID */</span>,</div><div class="line">    );</div><div class="line">    <span class="keyword">this</span>._renderedComponent = child;</div><div class="line"></div><div class="line"><span class="comment">//...</span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">   * @private</div><div class="line">   */</div><div class="line">  _renderValidatedComponent: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> renderedElement;</div><div class="line">    <span class="keyword">if</span> (</div><div class="line">      __DEV__ ||</div><div class="line">      <span class="keyword">this</span>._compositeType !== ReactCompositeComponentTypes.StatelessFunctional</div><div class="line">    ) &#123;</div><div class="line">      ReactCurrentOwner.current = <span class="keyword">this</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        renderedElement = <span class="keyword">this</span>._renderValidatedComponentWithoutOwnerOrContext();</div><div class="line">      &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        ReactCurrentOwner.current = <span class="literal">null</span>;</div><div class="line">      &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      renderedElement = <span class="keyword">this</span>._renderValidatedComponentWithoutOwnerOrContext();</div><div class="line">    &#125;</div><div class="line">    invariant(</div><div class="line">      <span class="comment">// <span class="doctag">TODO:</span> An `isValidNode` function would probably be more appropriate</span></div><div class="line">      renderedElement === <span class="literal">null</span> ||</div><div class="line">        renderedElement === <span class="literal">false</span> ||</div><div class="line">        React.isValidElement(renderedElement),</div><div class="line">      <span class="string">'%s.render(): A valid React element (or null) must be returned. You may have '</span> +</div><div class="line">        <span class="string">'returned undefined, an array or some other invalid object.'</span>,</div><div class="line">      <span class="keyword">this</span>.getName() || <span class="string">'ReactCompositeComponent'</span>,</div><div class="line">    );</div><div class="line"></div><div class="line">    <span class="keyword">return</span> renderedElement;</div><div class="line">  &#125;</div><div class="line"></div><div class="line"><span class="comment">//...</span></div><div class="line"></div><div class="line"> _renderValidatedComponentWithoutOwnerOrContext: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> inst = <span class="keyword">this</span>._instance;</div><div class="line">    <span class="keyword">var</span> renderedElement;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (__DEV__) &#123;</div><div class="line">      renderedElement = measureLifeCyclePerf(</div><div class="line">        <span class="function"><span class="params">()</span> =&gt;</span> inst.render(),</div><div class="line">        <span class="keyword">this</span>._debugID,</div><div class="line">        <span class="string">'render'</span>,</div><div class="line">      );</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      renderedElement = inst.render();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (__DEV__) &#123;</div><div class="line">      <span class="comment">// We allow auto-mocks to proceed as if they're returning null.</span></div><div class="line">      <span class="keyword">if</span> (renderedElement === <span class="literal">undefined</span> &amp;&amp; inst.render._isMockFunction) &#123;</div><div class="line">        <span class="comment">// This is probably bad practice. Consider warning here and</span></div><div class="line">        <span class="comment">// deprecating this convenience.</span></div><div class="line">        renderedElement = <span class="literal">null</span>;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> renderedElement;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>观察这三个方法，发现这个 链表 结构原来是如此搭建起来的，所以 precacheNode 做的遍历实际上就是找到最终的子节点，用一个 随机生成的 key 来存储。</p>
<p><strong>false</strong>：<br>就不会进行上面的这一段处理，也就是说不会重用以前的 markup，而是直接生成将 markup 插入到响应的 dom node 里面去。</p>

      
    </div>

    
      
      

  <div class="post-copyright">
    <p class="copyright-item">
      <span>作者: </span>
      <span>ShiKaiWi</span>
    </p>
    <p class="copyright-item">
      <span>来源: </span>
      <a href="https://ShiKaiWi.github.io">https://ShiKaiWi.github.io</a>
    </p>
    <p class="copyright-item">
      <span>链接: </span>
      <a href="https://ShiKaiWi.github.io/2017/07/01/React-源码阅读-Component-Mount/">https://ShiKaiWi.github.io/2017/07/01/React-源码阅读-Component-Mount/</a>
    </p>

    <p class="copyright-item lincese">
      
      本文采用<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可
    </p>
  </div>



      
      
    

    
      <footer class="post-footer">
        <div class="post-tags">
          
            <a href="/tags/react/">react</a>
          
        </div>

        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2017/07/07/React-源码阅读-Component-Update/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">React-源码阅读-Component更新.md</span>
        <span class="prev-text nav-mobile">Prev</span>
      </a>
    
    
      <a class="next" href="/2017/06/15/Design-Rules/">
        <span class="next-text nav-default">Design-Rules</span>
        <span class="prev-text nav-mobile">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

      </footer>
    
  </article>


          </div>
          
  <div class="comments" id="comments">
    
  </div>

        </div>  
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
        
          <a href="mailto:xykwei@gmail.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
        
          <a href="https://github.com/ShiKaiWi" class="iconfont icon-github" title="github"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
    
    
  </div>


<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://hexo.io/">Hexo</a>
  </span>
  
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">
    
    &copy; 
    
    2017

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">ShiKaiWi</span>
  </span>
</div>
      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    


    
  





  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  

    <script type="text/javascript" src="/js/src/even.js?v=2.2.x"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=2.2.x"></script>

  </body>
</html>